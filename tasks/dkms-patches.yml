---
- name: Validate patch entries
  ansible.builtin.fail:
    msg: "Each patch must have src, version, and order fields"
  when: >
    lustre_dkms_patches | selectattr('src', 'undefined') | list | length > 0 or
    lustre_dkms_patches | selectattr('version', 'undefined') | list | length > 0 or
    lustre_dkms_patches | selectattr('order', 'undefined') | list | length > 0

- name: Ensure DKMS is installed
  ansible.builtin.package:
    name: dkms
    state: present

- name: Create patches directory
  ansible.builtin.file:
    path: "/usr/src/lustre-client-modules-{{ item }}/patches/"
    state: directory
    mode: '0755'
  loop: "{{ lustre_dkms_patches | map(attribute='version') | unique | list }}"

- name: Copy patch files
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "/usr/src/lustre-client-modules-{{ item.version }}/patches/"
    mode: '0644'
  loop: "{{ lustre_dkms_patches }}"

- name: Generate DKMS config files
  ansible.builtin.template:
    src: dkms.conf.j2
    dest: "/etc/dkms/lustre-client-modules-{{ item }}.conf"
    mode: '0644'
  loop: "{{ lustre_dkms_patches | map(attribute='version') | unique | list }}"
